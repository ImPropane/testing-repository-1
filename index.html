<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoScholar India - Refined Dark Glassmorphism UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-main: #0a0f1d;
            --accent-color: #8b5cf6; /* Vibrant Purple */
            --accent-color-hover: #a78bfa;
            --accent-glow: rgba(139, 92, 246, 0.3);
            --text-primary: #e6edf3;
            --text-secondary: #8d96a0;
            --border-color: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* --- Animated Gradient Background --- */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, var(--accent-color), #22d3ee, #db2777);
            background-size: 300% 300%;
            animation: gradient-flow 25s ease infinite;
            filter: blur(120px);
            opacity: 0.15;
            z-index: -1;
            transition: opacity 0.5s ease;
        }

        @keyframes gradient-flow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        h1, h2, h3, h4, .font-heading {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
        }

        @keyframes fade-in-up { 
            from { opacity: 0; transform: translateY(15px) scale(0.98); } 
            to { opacity: 1; transform: translateY(0) scale(1); } 
        }
        .animate-fade-in-up { animation: fade-in-up 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }

        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* --- Glassmorphism Panels --- */
        .glass-panel {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.25);
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }

        .form-input {
            background-color: rgba(15, 23, 42, 0.6);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            transition: all 0.2s ease;
        }
        .form-input:focus, .form-input:focus-within {
             outline: none;
             border-color: var(--accent-color);
             box-shadow: 0 0 0 3px var(--accent-glow);
             background-color: rgba(30, 41, 59, 0.8);
        }
        .form-checkbox {
            color: var(--accent-color);
            background: transparent;
            border-color: var(--border-color);
        }
        .form-checkbox:checked { 
            background-color: var(--accent-color); 
            border-color: var(--accent-color);
        }

        .result-card {
            opacity: 0;
            transform: translateY(20px);
            transition: transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94), 
                        box-shadow 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                        background 0.3s ease, border-color 0.3s ease;
        }

        .result-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(139, 92, 246, 0.5);
            background: rgba(30, 41, 59, 0.75);
            border-color: rgba(139, 92, 246, 0.5);
        }
        .top-match-badge {
            background: var(--accent-color);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 3px 10px;
            border-radius: 99px;
            text-transform: uppercase;
        }

        .primary-button {
            background-color: var(--accent-color);
            color: white;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
        }
        .primary-button:hover {
             background-color: var(--accent-color-hover);
             transform: translateY(-2px);
             box-shadow: 0 4px 15px var(--accent-glow);
        }
        .primary-button:active {
            transform: translateY(0) scale(0.98);
        }
        
        .secondary-button {
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
        }
        .secondary-button:hover {
             color: var(--text-primary);
             background-color: rgba(255, 255, 255, 0.1);
             border-color: rgba(255, 255, 255, 0.2);
        }
        
        .summary-button {
             background-color: rgba(139, 92, 246, 0.1);
             color: var(--accent-color-hover);
        }
        .summary-button:hover {
             background-color: rgba(139, 92, 246, 0.2);
             color: white;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-main); }
        ::-webkit-scrollbar-thumb { background: #22293b; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #3f4a64; }
        
        .tab-btn {
            color: var(--text-secondary);
            transition: all 0.2s ease;
            position: relative;
            padding-bottom: 8px;
        }
        .tab-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent-color);
            box-shadow: 0 0 10px var(--accent-glow);
            transform: scaleX(0);
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border-radius: 2px;
        }
        .tab-btn.active {
            color: var(--accent-color);
        }
        .tab-btn.active::after {
            transform: scaleX(1);
        }
        .tab-btn:hover:not(.active) { color: var(--text-primary); }

        .tag { @apply inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium; }
        .tag-government { 
            background-color: rgba(34, 211, 238, 0.1);
            color: #22d3ee;
        }
        .tag-private {
            background-color: rgba(219, 39, 119, 0.1);
            color: #f472b6;
        }

    </style>
</head>
<body class="font-sans">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-main text-center bg-gray-900/50 backdrop-blur-sm">
        <i data-lucide="loader-2" class="w-10 h-10 text-accent-color animate-spin"></i>
        <p class="mt-4 text-secondary text-sm">Loading Scholarships...</p>
    </div>

    <!-- Error Display Container -->
    <div id="error-container" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
        <div class="glass-panel p-8 w-full max-w-md text-center rounded-xl">
            <i data-lucide="alert-triangle" class="w-12 h-12 mx-auto text-red-500"></i>
            <h2 class="text-xl font-bold mt-4">Application Error</h2>
            <p class="text-secondary mt-2" id="error-message">Could not load critical data. Please check your connection and refresh.</p>
        </div>
    </div>
    
    <!-- AI Modal -->
    <div id="ai-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div id="ai-modal-content" class="glass-panel p-6 md:p-8 w-full max-w-2xl rounded-2xl animate-fade-in-up">
             <div class="flex justify-between items-center mb-4">
                <h3 id="ai-modal-title" class="text-xl font-bold flex items-center gap-2">
                    <i data-lucide="sparkles" class="text-accent-color"></i>
                    AI Feature
                </h3>
                <button id="close-ai-btn" class="text-secondary hover:text-primary transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="ai-modal-text" class="text-primary leading-relaxed max-h-[60vh] overflow-y-auto pr-2"></div>
        </div>
    </div>


    <!-- Main Application Content -->
    <div id="main-content" class="hidden main-container relative min-h-screen">
        <header class="sticky top-0 z-40 p-4">
             <div class="container mx-auto px-6 py-3 flex justify-between items-center glass-panel rounded-2xl">
                <h1 class="text-xl font-bold tracking-tight">GoScholar</h1>
                <div class="flex items-center">
                    <div class="flex space-x-8 items-center mr-8">
                        <button id="tab-finder" class="tab-btn text-sm font-semibold">Finder</button>
                        <button id="tab-all" class="tab-btn text-sm font-semibold">Database</button>
                        <button id="tab-credits" class="tab-btn text-sm font-semibold">Credits</button>
                    </div>
                </div>
            </div>
        </header>
        
        <main class="container mx-auto p-4 md:px-6 md:py-8">
            <!-- Finder Tab Content -->
            <div id="finder-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Left Column: Profile Form -->
                    <div class="lg:col-span-1">
                        <div class="glass-panel p-6 rounded-2xl sticky top-24">
                             <div class="flex justify-between items-center mb-6">
                                <h2 class="text-lg font-semibold">Your Profile</h2>
                                <button id="clear-form-btn" type="button" title="Reset Profile" class="text-secondary hover:text-primary transition-colors">
                                    <i data-lucide="rotate-cw" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <form id="scholarship-form" class="space-y-6">
                                <div class="space-y-4">
                                    <h3 class="text-sm font-semibold text-secondary uppercase tracking-wider">Academic Details</h3>
                                    <div id="academic-fields-container" class="space-y-4"></div>
                                </div>
                                <div class="space-y-4">
                                    <h3 class="text-sm font-semibold text-secondary uppercase tracking-wider">Personal & Financial</h3>
                                    <div><label for="category" class="block text-sm font-medium text-primary mb-1.5">Caste Category</label><select id="category" class="form-input w-full p-2.5 text-sm"><option value="GENERAL">General</option><option value="OBC">OBC</option><option value="SC">SC</option><option value="ST">ST</option><option value="MINORITY">Minority</option></select></div>
                                    <div><label for="income" class="block text-sm font-medium text-primary mb-1.5">Annual Family Income (₹)</label><input type="number" id="income" placeholder="e.g., 80000" class="form-input w-full p-2.5 text-sm"></div>
                                    <div><label for="state" class="block text-sm font-medium text-primary mb-1.5">State of Domicile</label><select id="state" class="form-input w-full p-2.5 text-sm"><option value="">Select your State</option></select></div>
                                </div>
                                <div class="space-y-4">
                                    <h3 class="text-sm font-semibold text-secondary uppercase tracking-wider">Other Criteria</h3>
                                    <div class="space-y-3 pt-1">
                                        <label class="flex items-center"><input type="checkbox" id="exServiceman" class="h-4 w-4 form-checkbox rounded-sm"><span class="ml-3 text-sm text-primary">Ward of Ex-Servicemen</span></label>
                                        <label class="flex items-center"><input type="checkbox" id="farmer" class="h-4 w-4 form-checkbox rounded-sm"><span class="ml-3 text-sm text-primary">Agricultural Background</span></label>
                                        <label class="flex items-center"><input type="checkbox" id="disabled" class="h-4 w-4 form-checkbox rounded-sm"><span class="ml-3 text-sm text-primary">Person with Disability (PwD)</span></label>
                                    </div>
                                    <div class="pt-2">
                                        <label class="block text-sm font-medium text-primary mb-2">Scholarship Type</label>
                                        <div class="flex items-center space-x-2 bg-black/20 p-1 rounded-lg">
                                            <label class="flex-1 text-center"><input type="radio" name="scholarshipType" value="All" class="sr-only peer" checked><span class="block px-3 py-1.5 rounded-md cursor-pointer text-xs font-semibold peer-checked:bg-slate-700 peer-checked:shadow-sm text-secondary peer-checked:text-white transition-all duration-200">All</span></label>
                                            <label class="flex-1 text-center"><input type="radio" name="scholarshipType" value="Government" class="sr-only peer"><span class="block px-3 py-1.5 rounded-md cursor-pointer text-xs font-semibold peer-checked:bg-slate-700 peer-checked:shadow-sm text-secondary peer-checked:text-white transition-all duration-200">Govt</span></label>
                                            <label class="flex-1 text-center"><input type="radio" name="scholarshipType" value="Private" class="sr-only peer"><span class="block px-3 py-1.5 rounded-md cursor-pointer text-xs font-semibold peer-checked:bg-slate-700 peer-checked:shadow-sm text-secondary peer-checked:text-white transition-all duration-200">Private</span></label>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Right Column: Scholarship Results -->
                    <div class="lg:col-span-2">
                        <div class="text-center mb-10 lg:text-left">
                             <h2 class="text-3xl md:text-4xl font-bold tracking-tight">Find Your Perfect Scholarship</h2>
                            <p class="mt-3 max-w-xl text-base text-secondary lg:max-w-none">Enter your details on the left and your results will appear here.</p>
                        </div>
                        <h2 id="results-title" class="text-xl font-bold text-primary mb-4">Your Matched Scholarships</h2>
                        <div id="results-container" class="grid grid-cols-1 md:grid-cols-2 gap-6 transition-opacity duration-300"></div>
                    </div>
                </div>
            </div>

            <!-- All Scholarships Content (Full Width) -->
            <div id="all-scholarships-content" class="hidden">
                 <div class="mb-8"><h2 class="text-3xl font-bold">Scholarship Database</h2><p class="text-secondary mt-1">Search our entire collection of scholarship opportunities.</p></div>
                 <div class="relative mb-6"><input type="text" id="all-scholarships-search" placeholder="Search by name, portal, or keywords..." class="w-full pl-10 pr-4 py-3 form-input"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="search" class="w-5 h-5 text-secondary"></i></div></div>
                 <div id="all-scholarships-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
            </div>
            
            <!-- Credits Content (Full Width) -->
            <div id="credits-content" class="hidden">
                 <div class="text-center mb-12"><h2 class="text-4xl md:text-5xl font-bold tracking-tight">Project Credits</h2></div>
                <div class="glass-panel p-8 md:p-12 max-w-2xl mx-auto rounded-2xl">
                    <h3 class="text-xl font-bold mb-6 text-center">Development Team</h3>
                     <ul class="grid grid-cols-2 gap-4 text-center">
                         <li class="text-base text-primary">Bhavartha Talvekar</li>
                         <li class="text-base text-primary">Bhumika Deshmukh</li>
                         <li class="text-base text-primary">Dhanasshree Borkar</li>
                         <li class="text-base text-primary">Dhanashree Mohod</li>
                         <li class="text-base text-primary">Dnyandeep Dhekle</li>
                         <li class="text-base text-primary">Gaurav Kale</li>
                     </ul>
                 </div>
            </div>
        </main>

        <footer class="mt-16 py-8 border-t border-slate-800">
            <div class="container mx-auto px-6 text-center text-secondary">
                <p class="text-xs font-semibold text-primary opacity-80">Disclaimer & Intellectual Property Notice</p>
                <p class="text-xs mt-2 max-w-4xl mx-auto opacity-60">
                    This project is the sole intellectual property of its original developer. No part may be used, copied, or modified without direct permission—even if granted by other team members. Unauthorized use will lead to strict action. Contact: 8459151327.
                </p>
            </div>
        </footer>
    </div>

    <script>
        const states = ["Andhra Pradesh","Arunachal Pradesh","Assam","Bihar","Chhattisgarh","Goa","Gujarat","Haryana","Himachal Pradesh","Jharkhand","Karnataka","Kerala","Madhya Pradesh","Maharashtra","Manipur","Meghalaya","Mizoram","Nagaland","Odisha","Punjab","Rajasthan","Sikkim","Tamil Nadu","Telangana","Tripura","Uttar Pradesh","Uttarakhand","West Bengal","Andaman and Nicobar Islands","Chandigarh","Dadra and Nagar Haveli and Daman and Diu","Delhi","Jammu and Kashmir","Ladakh","Lakshadweed","Puducherry"];
        let scholarships = [];
        // No API Keys are stored on the frontend anymore!

        const debounce = (func, delay = 400) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => { func.apply(this, args); }, delay); }; };

        document.addEventListener('DOMContentLoaded', () => {
            initializeApp(); 
            const aiModal = document.getElementById('ai-modal');
            const closeAIBtn = document.getElementById('close-ai-btn');
            closeAIBtn.addEventListener('click', () => aiModal.classList.add('hidden'));
            aiModal.addEventListener('click', (e) => {
                if (e.target === aiModal) {
                    aiModal.classList.add('hidden');
                }
            });
        });

        async function initializeApp() {
            try {
                const response = await fetch("https://goscholar-backend.propane.workers.dev/");
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                scholarships = await response.json();
            } catch (error) {
                console.error("Failed to fetch scholarships:", error);
                const errorContainer = document.getElementById('error-container');
                errorContainer.classList.remove('hidden');
                if (typeof lucide !== 'undefined') lucide.createIcons();
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
            }
            
            const stateSelect = document.getElementById('state');
            if (stateSelect.options.length <= 1) { states.forEach(state => stateSelect.add(new Option(state, state))); }

            const form = document.getElementById('scholarship-form');
            const debouncedFind = debounce(findScholarships);
            
            form.addEventListener('input', (e) => {
                if (e.target.type === 'number') validateNumberInput(e.target);
                if (e.target.id === 'studyLevel' || e.target.id === 'fieldOfStudy') updateAcademicFields();
                debouncedFind();
            });

            document.getElementById('clear-form-btn').addEventListener('click', () => {
                form.reset();
                updateAcademicFields();
                form.dispatchEvent(new Event('input'));
            });
            
            setupTabs();
            updateAcademicFields();
            findScholarships();
            displayAllScholarships();
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function validateNumberInput(input) {
             let value = parseFloat(input.value);
             const max = parseFloat(input.max);
             if (max && value > max) input.value = max;
        }

        function updateAcademicFields() {
            const container = document.getElementById('academic-fields-container');
            let currentLevel = container.querySelector('#studyLevel')?.value || 'UG';
            let currentField = container.querySelector('#fieldOfStudy')?.value;
            container.innerHTML = '';

            const createLabel = (id, text) => `<label for="${id}" class="block text-sm font-medium text-primary mb-1.5">${text}</label>`;
            const createSelect = (id, options) => `<select id="${id}" class="form-input w-full p-2.5 text-sm">${options}</select>`;
            const createInput = (id, placeholder = '', type = 'number', max = 100, step = 1) => `<input type="${type}" id="${id}" min="0" max="${max}" step="${step}" placeholder="${placeholder}" class="form-input w-full p-2.5 text-sm">`;

            const levelOptions = `
                <option value="PreMatric">Pre-Matric (Nursery-10)</option>
                <option value="PostMatric">Post-Matric (11-12)</option>
                <option value="UG">Undergraduate (UG)</option>
                <option value="PG">Postgraduate (PG)</option>
                <option value="Doctoral">Doctoral (Ph.D.)</option>
                <option value="PostDoctoral">Post-Doctoral</option>`;
            container.insertAdjacentHTML('beforeend', `<div>${createLabel('studyLevel', 'Current Level of Study')}${createSelect('studyLevel', levelOptions)}</div>`);
            container.querySelector('#studyLevel').value = currentLevel;

            const fieldGroups = {
                UG: {"General": ["BA", "BSc", "B.Com"], "Technical": ["B.E/B.Tech", "Architecture"], "Medical": ["MBBS", "BDS", "Nursing", "Pharmacy"], "Management/IT": ["BBA", "BCA"], "Other": ["Law", "Education"]},
                PG: {"General": ["MA", "MSc", "M.Com"], "Technical": ["M.Tech"], "Medical": ["MD", "MS"], "Management/IT": ["MBA", "MCA"], "Other": ["LLM", "M.Ed"]},
                Doctoral: { "Research": ["Ph.D.", "M.Phil"] },
                PostDoctoral: { "Research": ["Post-Doctoral"] }
            };

            let fieldOptionsHTML = '';
            let fieldDisabled = false;
            
            if (currentLevel === 'PreMatric') {
                fieldDisabled = true; fieldOptionsHTML = `<option value="General">General</option>`;
            } else if (currentLevel === 'PostMatric') {
                fieldOptionsHTML = `<option value="Science">Science</option><option value="Commerce">Commerce</option><option value="Arts">Arts</option>`;
            } else if (fieldGroups[currentLevel]) {
                Object.entries(fieldGroups[currentLevel]).forEach(([group, opts]) => {
                    fieldOptionsHTML += `<optgroup label="${group}">${opts.map(o => `<option value="${o}">${o}</option>`).join('')}</optgroup>`;
                });
            }

            container.insertAdjacentHTML('beforeend', `<div><label for="fieldOfStudy" class="block text-sm font-medium text-primary mb-1.5">Field of Study</label><select id="fieldOfStudy" class="form-input w-full p-2.5 text-sm" ${fieldDisabled ? 'disabled' : ''}>${fieldOptionsHTML}</select></div>`);
            const fieldSelect = container.querySelector('#fieldOfStudy');
            if (currentField && Array.from(fieldSelect.options).some(o => o.value === currentField)) {
                fieldSelect.value = currentField;
            }
            currentField = fieldSelect.value;
            
            let specificFieldsHTML = '';
            if (['PostMatric', 'UG', 'PG', 'Doctoral', 'PostDoctoral'].includes(currentLevel)) specificFieldsHTML += `<div>${createLabel('marks10', '10th Percentage (%)')}${createInput('marks10', 'e.g., 85')}</div>`;
            if (['UG', 'PG', 'Doctoral', 'PostDoctoral'].includes(currentLevel)) specificFieldsHTML += `<div>${createLabel('marks12', '12th Percentage (%)')}${createInput('marks12', 'e.g., 85')}</div>`;
            if (['PG', 'Doctoral', 'PostDoctoral'].includes(currentLevel)) specificFieldsHTML += `<div>${createLabel('marksUG', 'UG CGPA / Percentage')}${createInput('marksUG', 'e.g., 8.5', 'number', 10, 0.1)}</div>`;
            if (['Doctoral', 'PostDoctoral'].includes(currentLevel)) specificFieldsHTML += `<div>${createLabel('marksPG', 'PG Percentage (%)')}${createInput('marksPG', 'e.g., 75')}</div>`;
            if (currentLevel === 'PreMatric') {
                const classOptions = Array.from({length: 10}, (_, i) => `<option value="${i + 1}">${i + 1}</option>`).join('');
                specificFieldsHTML += `<div>${createLabel('currentClass', 'Current Class')}${createSelect('currentClass', classOptions)}</div>`;
                specificFieldsHTML += `<div>${createLabel('marksPrev', 'Previous Class %')}${createInput('marksPrev', 'e.g., 90')}</div>`;
            } else if (currentLevel === 'UG' && currentField === "B.E/B.Tech") {
                const semOptions = Array.from({length: 8}, (_, i) => `<option value="${i + 1}">Semester ${i + 1}</option>`).join('');
                specificFieldsHTML += `<div>${createLabel('currentSemester', 'Current Semester')}${createSelect('currentSemester', semOptions)}</div>`;
                specificFieldsHTML += `<div>${createLabel('cgpa', 'Previous Sem CGPA')}${createInput('cgpa', 'e.g., 8.5', 'number', 10, 0.1)}</div>`;
            }
            container.insertAdjacentHTML('beforeend', specificFieldsHTML);
        }

        function setupTabs() {
            const tabs = document.querySelectorAll('.tab-btn');
            const contents = [document.getElementById('finder-content'), document.getElementById('all-scholarships-content'), document.getElementById('credits-content')];
            const setActiveTab = (activeIndex) => {
                tabs.forEach((tab, index) => tab.classList.toggle('active', index === activeIndex));
                contents.forEach((content, index) => content.style.display = (index === activeIndex) ? 'block' : 'none');
            };
            tabs.forEach((tab, index) => tab.addEventListener('click', () => setActiveTab(index)));
            setActiveTab(0);
            const searchInput = document.getElementById('all-scholarships-search');
            searchInput.addEventListener('input', debounce(() => displayAllScholarships(searchInput.value), 300));
        }

        // --- AI SUMMARY FUNCTIONS ---
        function openAIModal(title, scholarship, buttonElement, type) {
            const aiModal = document.getElementById('ai-modal');
            const aiModalTitle = document.getElementById('ai-modal-title');
            const aiModalText = document.getElementById('ai-modal-text');
            const originalButtonContent = buttonElement.innerHTML;
            
            aiModalTitle.innerHTML = `<i data-lucide="sparkles" class="text-accent-color"></i> ${title}`;
            aiModal.classList.remove('hidden');
            aiModalText.innerHTML = `
                <div class="animate-pulse space-y-3">
                    <div class="h-4 bg-slate-700 rounded w-3/4 mb-2"></div>
                    <div class="h-4 bg-slate-700 rounded w-full"></div>
                    <div class="h-4 bg-slate-700 rounded w-5/6"></div>
                </div>`;

            buttonElement.disabled = true;
            buttonElement.innerHTML = `<i data-lucide="loader-2" class="animate-spin h-4 w-4 mx-auto"></i>`;
            if(typeof lucide !== 'undefined') lucide.createIcons();

            callAIWorker(scholarship, type).then(result => {
                aiModalText.innerHTML = result.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            }).catch(err => {
                let errorMessage = `<strong>⚠ Could not load result.</strong><br><small>${err.message}</small>`;
                if (err.message.includes("is currently loading")) {
                    errorMessage = `<strong>AI Model is starting up.</strong><br><small>This can take up to 20 seconds on the free tier. Please try again in a moment.</small>`
                }
                aiModalText.innerHTML = `<p class="text-red-400">${errorMessage}</p>`;
                console.error(err);
            }).finally(() => {
                buttonElement.disabled = false;
                buttonElement.innerHTML = originalButtonContent;
                if(typeof lucide !== 'undefined') lucide.createIcons();
            });
        }

        function closeSummary() {
            document.getElementById('ai-modal').classList.add('hidden');
        }

        async function callAIWorker(scholarship, type) {
            const endpoint = type === 'summary' ? '/summarize' : '/eligibility-check';
            const payload = { scholarship };

            if (type === 'eligibility-check') {
                payload.student = {
                    level: document.getElementById('studyLevel')?.value,
                    stream: document.getElementById('fieldOfStudy')?.value,
                    currentClass: parseInt(document.getElementById('currentClass')?.value, 10) || 0,
                    currentSemester: parseInt(document.getElementById('currentSemester')?.value, 10) || 0,
                    marksPrev: parseInt(document.getElementById('marksPrev')?.value, 10) || 0,
                    marks10: parseInt(document.getElementById('marks10')?.value, 10) || 0,
                    marks12: parseInt(document.getElementById('marks12')?.value, 10) || 0,
                    marksUG: parseInt(document.getElementById('marksUG')?.value, 10) || 0,
                    marksPG: parseInt(document.getElementById('marksPG')?.value, 10) || 0,
                    cgpa: parseFloat(document.getElementById('cgpa')?.value) || 0,
                    category: document.getElementById('category').value,
                    income: parseInt(document.getElementById('income').value, 10) || 0,
                    domicile: document.getElementById('state').value,
                    isExServiceman: document.getElementById('exServiceman').checked,
                    isFarmer: document.getElementById('farmer').checked,
                    isDisabled: document.getElementById('disabled').checked
                };
            }
            
            const response = await fetch(`https://goscholar-backend.propane.workers.dev${endpoint}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || "Failed to fetch from the backend worker.");
            }

            const data = await response.json();
            if (data.result) {
                return data.result;
            }
            
            throw new Error("Unexpected response format from the backend worker.");
        }
        
        // --- CORE LOGIC ---
        
        function calculateMatchScore(scholarship, student) {
            const e = scholarship.eligibility;
            if (e.level && !e.level.includes(student.level)) return 0;
            if (student.scholarshipType !== 'All' && scholarship.type !== student.scholarshipType) return 0;
            if (e.income && student.income > 0 && e.income < student.income) return 0;
            if (e.category && !e.category.includes(student.category)) return 0;
            if (e.stream && !e.stream.includes(student.stream) && !e.stream.includes("All")) return 0;
            if (e.minClass && student.currentClass > 0 && e.minClass > student.currentClass) return 0;
            if (e.maxClass && student.currentClass > 0 && e.maxClass < student.currentClass) return 0;
            if (e.minMarksPrev && student.marksPrev > 0 && e.minMarksPrev > student.marksPrev) return 0;
            if (e.minMarks10 && student.marks10 > 0 && e.minMarks10 > student.marks10) return 0;
            if (e.minMarks12 && student.marks12 > 0 && e.minMarks12 > student.marks12) return 0;
            if (e.minMarksUG && student.marksUG > 0 && e.minMarksUG > student.marksUG) return 0;
            if (e.minMarksPG && student.marksPG > 0 && e.minMarksPG > student.marksPG) return 0;
            if (e.minCGPA && student.cgpa > 0 && e.minCGPA > student.cgpa) return 0;
            if (e.minSemester && student.currentSemester > 0 && e.minSemester > student.currentSemester) return 0;
            if (e.domicile && student.domicile && !e.domicile.includes(student.domicile)) return 0;
            if (e.isDisabled && !student.isDisabled) return 0;
            if (e.isExServiceman && !student.isExServiceman) return 0;
            if (e.isFarmer && !student.isFarmer) return 0;

            let score = 1;
            if (e.domicile && e.domicile.includes(student.domicile)) score += 5;
            if (e.stream && e.stream.includes(student.stream)) score += 5;
            if (e.isDisabled && student.isDisabled) score += 4;
            if (e.isExServiceman && student.isExServiceman) score += 4;
            if (e.isFarmer && student.isFarmer) score += 4;
            return score;
        }

        function findScholarships() {
            const student = {
                level: document.getElementById('studyLevel')?.value,
                stream: document.getElementById('fieldOfStudy')?.value,
                currentClass: parseInt(document.getElementById('currentClass')?.value, 10) || 0,
                currentSemester: parseInt(document.getElementById('currentSemester')?.value, 10) || 0,
                marksPrev: parseInt(document.getElementById('marksPrev')?.value, 10) || 0,
                marks10: parseInt(document.getElementById('marks10')?.value, 10) || 0,
                marks12: parseInt(document.getElementById('marks12')?.value, 10) || 0,
                marksUG: parseInt(document.getElementById('marksUG')?.value, 10) || 0,
                marksPG: parseInt(document.getElementById('marksPG')?.value, 10) || 0,
                cgpa: parseFloat(document.getElementById('cgpa')?.value) || 0,
                scholarshipType: document.querySelector('input[name="scholarshipType"]:checked')?.value || 'All',
                category: document.getElementById('category').value,
                income: parseInt(document.getElementById('income').value, 10) || 0,
                domicile: document.getElementById('state').value,
                isExServiceman: document.getElementById('exServiceman').checked,
                isFarmer: document.getElementById('farmer').checked,
                isDisabled: document.getElementById('disabled').checked
            };

            const scoredScholarships = scholarships
                .map(s => ({ ...s, matchScore: calculateMatchScore(s, student) }))
                .filter(s => s.matchScore > 0)
                .sort((a, b) => b.matchScore - a.matchScore);

            displayResults(scoredScholarships, student);
        }

        function displayResults(results, student) {
            const container = document.getElementById('results-container');
            const title = document.getElementById('results-title');
            
            const hasRequiredInput = student.income > 0 || student.marksPrev > 0 || student.marks10 > 0 || student.marks12 > 0 || student.marksUG > 0 || student.marksPG > 0 || student.cgpa > 0;
            
            container.classList.add('opacity-0');

            setTimeout(() => {
                container.innerHTML = '';
                
                if (!hasRequiredInput) {
                    title.textContent = 'Start by filling in your profile';
                    container.innerHTML = `<div class="bg-purple-900/20 border-l-4 border-[var(--accent-color)] p-6 rounded-r-xl col-span-1 md:col-span-3 text-center animate-fade-in-up"><h3 class="font-semibold text-[var(--accent-color)]">Ready to find scholarships?</h3><p class="mt-1 text-sm text-secondary">Fill in your details above to begin.</p></div>`;
                } else {
                    title.innerHTML = `Found <span class="text-[var(--accent-color)]">${results.length}</span> Matching Scholarships`;

                    if (results.length === 0) {
                        container.innerHTML = `<div class="glass-panel p-8 rounded-xl text-center col-span-1 md:col-span-3 animate-fade-in-up"><i data-lucide="search-x" class="mx-auto h-10 w-10 text-secondary" stroke-width="1.5"></i><h3 class="mt-4 text-base font-semibold text-primary">No Matching Scholarships Found</h3><p class="mt-1 text-sm text-secondary">We couldn't find any scholarships for your profile. Try adjusting the criteria.</p></div>`;
                    } else {
                        const maxScore = results.length > 0 ? results[0].matchScore : 0;
                        results.forEach((s, index) => {
                            s.cardId = `scholarship-${index}`;
                            container.appendChild(createScholarshipCard(s, index, s.matchScore >= maxScore && maxScore > 5))
                        });
                    }
                }
                
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
                container.classList.remove('opacity-0');

            }, 200);
        }

        function createScholarshipCard(s, index, isTopMatch = false) {
            const card = document.createElement('div');
            card.className = 'result-card glass-panel p-5 flex flex-col rounded-2xl';
            card.style.animation = `fade-in-up 0.4s ease-out ${index * 80}ms forwards`;
            card.id = s.cardId;
            
            const topMatchBadge = isTopMatch ? `<span class="top-match-badge flex items-center gap-1"><i data-lucide="star" class="w-3 h-3 fill-current"></i> Top Match</span>` : '';
            const typeClass = s.type.toLowerCase() === 'private' ? 'tag-private' : 'tag-government';

            const createEliItem = (icon, text) => `<li class="flex items-start text-sm"><i data-lucide="${icon}" class="w-4 h-4 mr-2.5 mt-0.5 text-secondary flex-shrink-0"></i><span class="text-primary">${text}</span></li>`;
            const eligibilityItems = [];
            if(s.eligibility.stream && s.eligibility.stream[0] !== 'All') eligibilityItems.push(createEliItem('award', `<strong>Stream:</strong> ${s.eligibility.stream.join(', ')}`));
            if(s.eligibility.income) eligibilityItems.push(createEliItem('indian-rupee', `<strong>Income:</strong> &lt; ₹${s.eligibility.income.toLocaleString('en-IN')}`));
            if(s.eligibility.minMarks12) eligibilityItems.push(createEliItem('percent', `<strong>Min 12th:</strong> ${s.eligibility.minMarks12}%`));
            if(s.eligibility.minMarks10) eligibilityItems.push(createEliItem('percent', `<strong>Min 10th:</strong> ${s.eligibility.minMarks10}%`));

            card.innerHTML = `
                ${isTopMatch ? `<div class="absolute top-4 right-4">${topMatchBadge}</div>` : ''}
                <div class="flex-grow">
                    <div class="flex items-center gap-2 mb-2">
                         <span class="tag ${typeClass}">${s.type}</span>
                    </div>
                    <h3 class="text-base font-bold text-primary pr-4">${s.name}</h3>
                    <p class="text-sm text-secondary mt-1">via ${s.portal}</p>
                    <div class="my-4 h-px bg-gradient-to-r from-transparent via-slate-700 to-transparent"></div>
                    <p class="text-primary mb-4 text-sm leading-relaxed">${s.description}</p>
                    <ul class="space-y-1.5">${eligibilityItems.slice(0, 3).join('')}</ul>
                </div>
                <div class="mt-5 flex-shrink-0 grid grid-cols-2 gap-3">
                     <button class="ai-button secondary-button inline-flex items-center justify-center w-full text-center px-4 py-2.5 text-sm">
                        Summarize <i data-lucide="sparkles" class="inline-block ml-1.5 h-4 w-4"></i>
                    </button>
                    <a href="${s.link}" target="_blank" class="primary-button inline-flex items-center justify-center w-full text-center px-4 py-2.5 text-sm">
                        Visit Portal <i data-lucide="arrow-right" class="inline-block ml-1.5 h-4 w-4"></i>
                    </a>
                </div>`;
            
            // Attach event listeners
            const summaryButton = card.querySelector('.ai-button');
            summaryButton.addEventListener('click', (e) => openAIModal('✨ AI Summary', s, e.currentTarget, 'summary'));


            return card;
        }
        
        function displayAllScholarships(searchText = "") {
            const container = document.getElementById('all-scholarships-list');
            container.innerHTML = '';
            const lowercasedSearch = searchText.toLowerCase();
            const filtered = scholarships.filter(s => s.name.toLowerCase().includes(lowercasedSearch) || s.portal.toLowerCase().includes(lowercasedSearch) || s.description.toLowerCase().includes(lowercasedSearch));
            
            if (filtered.length === 0) {
                 container.innerHTML = `<div class="md:col-span-2 xl:col-span-3 text-center py-10"><p class="text-secondary">No scholarships found for "${searchText}".</p></div>`;
                 return;
            }
            filtered.forEach((s, index) => {
                s.cardId = `all-scholarship-${index}`;
                container.appendChild(createScholarshipCard(s, index))
            });

            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
    </script>
</body>
</html>

